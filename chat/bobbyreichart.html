<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat | Bobby Reichert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .dark .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #475569;
        }
    </style>
    <script type="module">
        // CLOUDINARY CONFIGURATION
        const CLOUDINARY_CLOUD_NAME = "drmmnimpw";
        const CLOUDINARY_UPLOAD_PRESET = "bobbyreichert-chat";

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, onSnapshot, query, where, orderBy, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        
        // CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyA9GsP72R_43JW7rG8Dpvcvt_n2FbQe5SM",
            authDomain: "bobbyreichert-chat.firebaseapp.com",
            projectId: "bobbyreichert-chat",
            storageBucket: "bobbyreichert-chat.firebasestorage.app",
            messagingSenderId: "743766854322",
            appId: "1:743766854322:web:a492e9eb137d903a7b17ab",
            measurementId: "G-H5ZNQ9L4ME"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Use a fixed App ID for the public data path requirement
        const APP_ID = "chat-v1"; 

        // STATE
        let currentUser = null;
        let currentChatId = null;
        let unsubscribeChats = null;
        let unsubscribeMessages = null;
        // EDIT/REPLY STATE
        let replyingToMessage = null;
        let editingMessage = null;
        // FILE UPLOAD STATE
        let selectedFile = null;

        // DOM ELEMENTS
        const loginView = document.getElementById('login-view');
        const mainView = document.getElementById('main-view');
        const rootElement = document.documentElement;
        
        const replyPanel = document.getElementById('reply-panel');
        const replyContent = document.getElementById('reply-content');
        const previewPanel = document.getElementById('preview-panel');
        const previewContent = document.getElementById('preview-content');
        const messageInput = document.getElementById('message-input');
        const progressBar = document.getElementById('upload-progress-bar');
        const progressContainer = document.getElementById('upload-progress-container');


        // --- AUTH FUNCTIONS ---

        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');
            const btn = e.target.querySelector('button');

            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Signing In...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state listener handles the transition
            } catch (error) {
                console.error(error);
                errorMsg.textContent = "Invalid email or password.";
                errorMsg.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = 'Sign In';
            }
        }

        window.handleLogout = () => {
            signOut(auth);
        }

        // --- USER PROFILE & DATA ---

        async function ensureUserProfile(user) {
            const userRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', user.uid);
            const snap = await getDoc(userRef);

            if (!snap.exists()) {
                // Create default profile
                await setDoc(userRef, {
                    email: user.email,
                    username: user.email.split('@')[0],
                    theme: 'light',
                    uid: user.uid,
                    photoURL: user.photoURL || `https://ui-avatars.com/api/?name=${user.email.substring(0,2)}&background=random`
                });
                return 'light';
            } else {
                const data = snap.data();
                if (data.email !== user.email) {
                    await updateDoc(userRef, { email: user.email });
                }
                return data.theme || 'light';
            }
        }

        async function updateUserProfile(updates) {
            if (!currentUser) return;
            const userRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.uid);
            await updateDoc(userRef, updates);
        }
        
        // --- CHAT LOGIC ---

        function initChatListener() {
            const chatsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats');
            const q = query(chatsRef, where('userIds', 'array-contains', currentUser.uid), orderBy('updatedAt', 'desc'));

            unsubscribeChats = onSnapshot(q, (snapshot) => {
                const chatList = document.getElementById('chat-list');
                chatList.innerHTML = '';

                if (snapshot.empty) {
                    chatList.innerHTML = `<div class="p-4 text-center text-gray-400 text-sm">No chats yet.<br>Create one to get started!</div>`;
                    return;
                }

                snapshot.forEach(docSnap => {
                    const chat = docSnap.data();
                    const chatId = docSnap.id;
                    
                    const otherEmails = chat.participants ? chat.participants.filter(p => p.email !== currentUser.email).map(p => p.username || p.email.split('@')[0]).join(', ') : "Unknown";
                    const displayName = chat.name || otherEmails || "New Chat";
                    
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-lg cursor-pointer flex items-center gap-3 transition-colors ${currentChatId === chatId ? 'bg-blue-100 dark:bg-blue-900' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`;
                    div.onclick = () => loadChat(chatId, chat);
                    
                    div.innerHTML = `
                        <div class="h-10 w-10 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold flex-shrink-0">
                            ${displayName.substring(0,1).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline">
                                <h3 class="font-medium text-gray-900 dark:text-gray-100 truncate">${displayName}</h3>
                                ${chat.updatedAt ? `<span class="text-xs text-gray-400">${new Date(chat.updatedAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>` : ''}
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 truncate">${chat.lastMessage || 'No messages yet'}</p>
                        </div>
                    `;
                    chatList.appendChild(div);
                });
            });
        }

        window.createNewChat = async () => {
            const emailInput = document.getElementById('new-chat-email');
            const email = emailInput.value.trim();
            if (!email) return;

            showToast("Searching for user...", "info");

            const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');
            const q = query(usersRef, where('email', '==', email));
            const querySnapshot = await getDocs(q);

            let targetUser = null;
            if (!querySnapshot.empty) {
                targetUser = querySnapshot.docs[0].data();
            } else {
                showToast("User not found. They must login once first.", "error");
                return;
            }

            if (targetUser.uid === currentUser.uid) {
                showToast("You can't chat with yourself.", "error");
                return;
            }

            const chatData = {
                userIds: [currentUser.uid, targetUser.uid],
                participants: [
                    { email: currentUser.email, uid: currentUser.uid, username: currentUser.displayName || currentUser.email.split('@')[0] },
                    { email: targetUser.email, uid: targetUser.uid, username: targetUser.username || targetUser.email.split('@')[0] }
                ],
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                lastMessage: "Chat created"
            };

            try {
                const docRef = await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats'), chatData);
                closeModal('new-chat-modal');
                emailInput.value = '';
                loadChat(docRef.id, chatData);
            } catch (e) {
                console.error(e);
                showToast("Error creating chat.", "error");
            }
        }

        window.addUserToChat = async () => {
            if (!currentChatId) return;
            
            const emailInput = document.getElementById('add-user-email');
            const email = emailInput.value.trim();
            if (!email) return;

            const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');
            const q = query(usersRef, where('email', '==', email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                showToast("User not found.", "error");
                return;
            }

            const newUser = querySnapshot.docs[0].data();
            const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId);
            const chatSnap = await getDoc(chatRef);
            const chatData = chatSnap.data();

            if (chatData.userIds.includes(newUser.uid)) {
                showToast("User already in chat.", "error");
                return;
            }

            const updatedParticipants = [...chatData.participants, {
                email: newUser.email, 
                uid: newUser.uid, 
                username: newUser.username || newUser.email.split('@')[0]
            }];

            await updateDoc(chatRef, {
                userIds: arrayUnion(newUser.uid),
                participants: updatedParticipants,
                lastMessage: `${currentUser.email.split('@')[0]} added ${newUser.username}`
            });

            closeModal('add-user-modal');
            emailInput.value = '';
            showToast("User added!", "success");
            document.getElementById('chat-header-name').textContent = updatedParticipants.map(p => p.username).join(', ');
        }
        
        window.openRenameModal = () => {
            if (!currentChatId) return;
            const currentName = document.getElementById('chat-header-name').textContent;
            document.getElementById('rename-chat-input').value = currentName;
            openModal('rename-chat-modal');
        }

        window.renameChat = async () => {
            if (!currentChatId) return;

            const newName = document.getElementById('rename-chat-input').value.trim();
            if (!newName) {
                showToast("Chat name cannot be empty.", "error");
                return;
            }

            try {
                const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId);
                await updateDoc(chatRef, {
                    name: newName,
                    updatedAt: serverTimestamp()
                });

                document.getElementById('chat-header-name').textContent = newName;
                closeModal('rename-chat-modal');
                showToast("Chat renamed!", "success");
            } catch (e) {
                console.error("Rename error", e);
                showToast("Failed to rename chat.", "error");
            }
        }

        function loadChat(chatId, chatData) {
            currentChatId = chatId;
            
            const items = document.getElementById('chat-list').children;
            for(let item of items) {
                item.classList.remove('bg-blue-100', 'dark:bg-blue-900');
            }
            
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('chat-interface').classList.remove('hidden');

            const displayName = chatData.name || (chatData.participants 
                ? chatData.participants.filter(p => p.uid !== currentUser.uid).map(p => p.username || p.email.split('@')[0]).join(', ')
                : "Chat");
            document.getElementById('chat-header-name').textContent = displayName;
            
            cancelEdit();
            cancelReply();
            cancelAttachment(); // Clear any pending uploads

            if (unsubscribeMessages) unsubscribeMessages();
            
            const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('createdAt', 'asc'));

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                
                snapshot.forEach(doc => {
                    renderMessage(doc.data(), doc.id, container);
                });
                
                container.scrollTop = container.scrollHeight;
            });
        }

        window.setReplyTarget = (messageId, senderName, content) => {
            if (editingMessage) cancelEdit(); 
            // Sanitize content for preview
            const sanitizedContent = content
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
            
            replyingToMessage = { id: messageId, senderName: senderName, content: content };
            replyContent.innerHTML = `Replying to **${senderName}**: ${sanitizedContent.length > 50 ? sanitizedContent.substring(0, 50) + '...' : sanitizedContent}`;
            replyPanel.classList.remove('hidden');
            messageInput.focus();
        }

        window.cancelReply = () => {
            replyingToMessage = null;
            replyPanel.classList.add('hidden');
            replyContent.innerHTML = '';
        }
        
        window.setEditTarget = (messageId, content) => {
            if (replyingToMessage) cancelReply(); 
            
            editingMessage = { id: messageId };
            messageInput.value = content;
            
            document.getElementById('send-button-icon').style.display = 'none';
            document.getElementById('edit-button-icon').style.display = 'block';
            document.getElementById('cancel-edit-button').style.display = 'block';
            messageInput.focus();
        }

        window.cancelEdit = () => {
            editingMessage = null;
            messageInput.value = '';
            document.getElementById('send-button-icon').style.display = 'block';
            document.getElementById('edit-button-icon').style.display = 'none';
            document.getElementById('cancel-edit-button').style.display = 'none';
        }

        // --- ATTACHMENT LOGIC ---
        
        window.handleFileUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            selectedFile = file;
            
            // Show preview
            previewPanel.classList.remove('hidden');
            const isImage = file.type.startsWith('image/');
            
            if (isImage) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewContent.innerHTML = `
                        <div class="relative group">
                            <img src="${e.target.result}" class="h-20 w-auto rounded border border-gray-300 dark:border-gray-600">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all rounded"></div>
                        </div>
                        <span class="text-xs text-gray-500 mt-1 block max-w-[150px] truncate">${file.name}</span>
                    `;
                }
                reader.readAsDataURL(file);
            } else {
                previewContent.innerHTML = `
                    <div class="h-20 w-20 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <span class="text-xs text-gray-500 mt-1 block max-w-[150px] truncate">${file.name}</span>
                `;
            }
            
            e.target.value = ''; // reset so same file can be selected again
        }

        window.cancelAttachment = () => {
            selectedFile = null;
            previewPanel.classList.add('hidden');
            previewContent.innerHTML = '';
        }

        // --- LINKIFY UTILITY ---
        function linkify(text, isMe) {
            if (!text) return '';
            
            // 1. Escape HTML Characters to prevent XSS
            const escaped = text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");

            // 2. Regex for URL recognition (http, https, ftp, file)
            // Matches protocol://domain... until space or end of string
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            
            return escaped.replace(urlRegex, (url) => {
                // Style links differently based on who sent the message (white vs blue)
                const linkClass = isMe 
                    ? 'underline text-white font-medium hover:opacity-80' 
                    : 'underline text-blue-600 dark:text-blue-400 hover:opacity-80';
                
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="${linkClass} break-all" onclick="event.stopPropagation();">${url}</a>`;
            });
        }

        function renderMessage(msg, id, container) {
            const isMe = msg.senderId === currentUser.uid;
            const timeString = msg.createdAt ? new Date(msg.createdAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';

            const div = document.createElement('div');
            div.className = `flex w-full mb-4 ${isMe ? 'justify-end' : 'justify-start'}`;
            
            let contentHtml = '';
            let captionHtml = '';
            
            // Helper for caption logic
            if (msg.content && msg.content !== 'Sent an image' && msg.content !== 'Sent a file') {
                const linkedContent = linkify(msg.content, isMe);
                captionHtml = `<p class="mt-2 text-sm ${isMe ? 'text-white/90' : 'text-gray-600 dark:text-gray-300'} whitespace-pre-wrap border-t ${isMe ? 'border-white/20' : 'border-gray-300 dark:border-gray-600'} pt-2">${linkedContent}</p>`;
            }

            if (msg.type === 'text') {
                // Use linkify function here
                contentHtml = `<p class="whitespace-pre-wrap">${linkify(msg.content, isMe)}</p>`;
            } else if (msg.type === 'image') {
                contentHtml = `
                    <div class="relative">
                        <img src="${msg.fileUrl}" class="max-w-xs md:max-w-sm rounded-lg cursor-pointer hover:opacity-95 transition-opacity" onclick="window.open('${msg.fileUrl}', '_blank')" />
                        ${captionHtml}
                    </div>`;
            } else if (msg.type === 'file') {
                contentHtml = `
                    <div>
                        <a href="${msg.fileUrl}" target="_blank" class="flex items-center gap-3 p-2 rounded-lg bg-black/5 hover:bg-black/10 dark:bg-white/5 dark:hover:bg-white/10 transition-colors">
                            <div class="bg-white dark:bg-gray-800 p-2 rounded text-blue-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium truncate">${msg.fileName || 'Download File'}</p>
                                <p class="text-xs opacity-70">Click to download</p>
                            </div>
                        </a>
                        ${captionHtml}
                    </div>`;
            }
            
            let replyHtml = '';
            if (msg.replyTo) {
                // Also escape reply content content to be safe
                const safeReplyContent = msg.replyTo.content
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");

                replyHtml = `
                    <div class="border-l-4 border-blue-400 pl-3 mb-2 pt-1 pb-1 bg-gray-100 dark:bg-gray-600 rounded-r text-xs ${isMe ? 'text-white/80' : 'text-gray-600 dark:text-gray-300'}">
                        <p class="font-bold text-blue-600 dark:text-blue-300">${msg.replyTo.senderName}</p>
                        <p class="truncate">${safeReplyContent}</p>
                    </div>
                `;
            }

            let editButtonHtml = '';
            if (isMe && msg.type === 'text') {
                editButtonHtml = `
                    <button onclick="setEditTarget('${id}', \`${msg.content.replace(/`/g, '\\`')}\`)" 
                            class="text-gray-400 hover:text-yellow-500 opacity-0 group-hover:opacity-100 transition-opacity ml-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </button>
                `;
            }

            div.innerHTML = `
                <div class="max-w-[75%] group">
                    <div class="text-xs mb-1 flex items-center ${isMe ? 'justify-end' : 'justify-start'} gap-2">
                        ${isMe ? 
                            `<span class="text-gray-500 dark:text-gray-400">${timeString}</span>
                             <span class="font-medium text-gray-800 dark:text-gray-100">${msg.senderName}</span>` 
                            : 
                            `<span class="font-medium text-gray-800 dark:text-gray-100">${msg.senderName}</span>
                             <span class="text-gray-500 dark:text-gray-400">${timeString}</span>`
                        }
                    </div>
                    <div class="flex items-end ${isMe ? 'flex-row-reverse' : 'flex-row'} gap-1">
                        <div class="p-3 rounded-2xl ${isMe ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-bl-none'}">
                            ${replyHtml}
                            ${contentHtml}
                            ${msg.editedAt ? '<span class="text-xs opacity-75 mt-1 block"> (Edited)</span>' : ''}
                        </div>
                        
                        <div class="flex items-center self-center">
                            <button onclick="setReplyTarget('${id}', '${msg.senderName}', \`${msg.content.replace(/`/g, '\\`')}\`)" 
                                    class="text-gray-400 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity ${isMe ? 'order-2' : 'order-1'}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a5 5 0 015 5v2m-5-2V7a5 5 0 00-5 5H3"></path></svg>
                            </button>
                            ${editButtonHtml}
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        window.sendMessage = async () => {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            // Don't send if empty AND no file
            if ((!text && !selectedFile) || !currentChatId) return;
            
            try {
                // If there's a file, handle upload logic
                if (selectedFile) {
                    await uploadAndSend(selectedFile, text);
                    input.value = '';
                    cancelAttachment();
                    return; // Done
                }

                // If text only...
                if (editingMessage) {
                    const messageRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages', editingMessage.id);
                    await updateDoc(messageRef, {
                        content: text,
                        editedAt: serverTimestamp()
                    });
                    cancelEdit();
                    input.value = '';
                    showToast("Message edited!", "success");

                } else {
                    const messageData = {
                        content: text,
                        type: 'text',
                        senderId: currentUser.uid,
                        senderName: currentUser.displayName || currentUser.email.split('@')[0],
                        createdAt: serverTimestamp()
                    };
                    
                    if (replyingToMessage) {
                        messageData.replyTo = {
                            messageId: replyingToMessage.id,
                            senderName: replyingToMessage.senderName,
                            content: replyingToMessage.content
                        };
                        cancelReply();
                    }

                    const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages');
                    await addDoc(messagesRef, messageData);
                    
                    const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId);
                    await updateDoc(chatRef, {
                        lastMessage: text,
                        updatedAt: serverTimestamp()
                    });
                    
                    input.value = '';
                }
            } catch (e) {
                console.error("Action error", e);
                showToast("Failed to send/edit", "error");
            }
        }

        document.getElementById('message-input').addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file') {
                    const blob = item.getAsFile();
                    // Mock event structure for handleFileUpload
                    window.handleFileUpload({ target: { files: [blob], value: '' } });
                }
            }
        });

        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function uploadAndSend(file, caption) {
            if (!currentChatId) return;
            
            // Show progress bar
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            
            const isImage = file.type.startsWith('image/');
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            try {
                // XHR for Progress Tracking
                const url = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, true);

                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            progressBar.style.width = percentComplete + '%';
                        }
                    };

                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            resolve(response.secure_url);
                        } else {
                            reject(new Error('Cloudinary upload failed'));
                        }
                    };

                    xhr.onerror = () => reject(new Error('Network error during upload'));
                    xhr.send(formData);
                });

                // Default captions if none provided
                const defaultText = isImage ? 'Sent an image' : 'Sent a file';
                const finalContent = caption || defaultText;

                // Save to Firestore
                const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages');
                await addDoc(messagesRef, {
                    content: finalContent,
                    type: isImage ? 'image' : 'file',
                    fileUrl: url,
                    fileName: file.name || 'uploaded-file',
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email.split('@')[0],
                    createdAt: serverTimestamp()
                });

                const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId);
                await updateDoc(chatRef, {
                    lastMessage: isImage ? 'ðŸ“· Image' : 'ðŸ“Ž File',
                    updatedAt: serverTimestamp()
                });
                
            } catch (e) {
                console.error("Upload failed", e);
                showToast("Upload failed", "error");
            } finally {
                // Hide progress bar
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                }, 1000);
            }
        }

        // --- SETTINGS & THEME ---

        window.toggleTheme = async () => {
            const isDark = rootElement.classList.contains('dark');
            if (isDark) {
                rootElement.classList.remove('dark');
                await updateUserProfile({ theme: 'light' });
            } else {
                rootElement.classList.add('dark');
                await updateUserProfile({ theme: 'dark' });
            }
        }

        window.saveSettings = async () => {
            const newUsername = document.getElementById('settings-username').value.trim();
            if (newUsername) {
                await updateUserProfile({ username: newUsername });
                currentUser.displayName = newUsername; 
                showToast("Profile updated!", "success");
                closeModal('settings-modal');
            }
        }

        window.resetPassword = async () => {
             if (!currentUser || !currentUser.email) return;

             const confirmed = confirm(`Send password reset email to ${currentUser.email}?`);
             if (!confirmed) return;

             try {
                 await sendPasswordResetEmail(auth, currentUser.email);
                 showToast("Reset email sent. Check your inbox.", "success");
             } catch (e) {
                 console.error("Reset password error", e);
                 showToast("Error sending reset email.", "error");
             }
        }

        // --- AUTH OBSERVER ---
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                mainView.classList.remove('hidden');
                
                const theme = await ensureUserProfile(user);
                if (theme === 'dark') rootElement.classList.add('dark');
                else rootElement.classList.remove('dark');

                const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', user.uid));
                if (snap.exists()) {
                    currentUser.displayName = snap.data().username;
                    document.getElementById('settings-username').value = snap.data().username;
                    document.getElementById('user-display-name').textContent = snap.data().username;
                    document.getElementById('user-avatar-initial').textContent = snap.data().username.substring(0,1).toUpperCase();
                }

                initChatListener();
            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                mainView.classList.add('hidden');
                if (unsubscribeChats) unsubscribeChats();
                if (unsubscribeMessages) unsubscribeMessages();
            }
        });

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-gray-800';
            toast.className = `fixed bottom-4 right-4 ${colors} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-10 opacity-0 z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });
            
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200 h-screen overflow-hidden font-sans text-gray-800 dark:text-gray-200">

    <div id="login-view" class="h-full flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100 dark:border-gray-700">
            <div class="text-center mb-8">
                <div class="h-16 w-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-blue-500/30">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.013 8.013 0 01-5.699-2.399l-5.102 1.488 1.488-5.102A8.013 8.013 0 014 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path></svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Welcome Back</h1>
                <p class="text-gray-500 text-sm mt-2">Sign in to your chat</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1">Email</label>
                    <input type="email" id="email" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white" required>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1">Password</label>
                    <input type="password" id="password" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white" required>
                </div>
                
                <div id="login-error" class="hidden text-red-500 text-sm text-center bg-red-50 dark:bg-red-900/20 p-2 rounded"></div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors shadow-lg shadow-blue-500/30">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <div id="main-view" class="hidden h-full flex flex-col md:flex-row">
        
        <div class="w-full md:w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col z-10">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <div class="flex items-center gap-3 cursor-pointer" onclick="openModal('settings-modal')">
                    <div class="h-10 w-10 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-lg">
                        <span id="user-avatar-initial">U</span>
                    </div>
                    <div>
                        <h2 id="user-display-name" class="font-bold text-sm leading-tight">User</h2>
                        <p class="text-xs text-green-500 flex items-center gap-1"><span class="block w-2 h-2 rounded-full bg-green-500"></span> Online</p>
                    </div>
                </div>
                <button onclick="openModal('settings-modal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </div>

            <div class="p-3">
                <button onclick="openModal('new-chat-modal')" class="w-full bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 py-2 rounded-lg font-medium text-sm flex items-center justify-center gap-2 hover:bg-blue-100 dark:hover:bg-blue-900/50 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    New Chat
                </button>
            </div>

            <div id="chat-list" class="flex-1 overflow-y-auto custom-scroll px-3 space-y-1">
                </div>
        </div>

        <div class="flex-1 flex flex-col bg-gray-50 dark:bg-gray-900 relative">
            
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 p-8 text-center z-0">
                <div class="w-24 h-24 bg-gray-200 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.013 8.013 0 01-5.699-2.399l-5.102 1.488 1.488-5.102A8.013 8.013 0 014 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path></svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-300">Select a chat to start messaging</h3>
                <p class="max-w-xs mt-2 text-sm">Or click 'New Chat' to start a conversation</p>
            </div>

            <div id="chat-interface" class="hidden flex flex-col h-full z-10 bg-white dark:bg-gray-900/50 backdrop-blur-sm">
                <!-- Upload Progress Bar -->
                <div id="upload-progress-container" class="hidden h-1 bg-gray-200 dark:bg-gray-700 w-full absolute top-0 left-0 z-20">
                    <div id="upload-progress-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                </div>

                <div class="h-16 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-6 bg-white dark:bg-gray-800 shadow-sm relative">
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-600 dark:text-indigo-300 font-bold">
                            #
                        </div>
                        <h3 id="chat-header-name" class="font-bold text-gray-800 dark:text-gray-100">Chat Name</h3>
                    </div>
                    <div>
                        <button onclick="openModal('add-user-modal')" class="text-gray-500 hover:text-blue-500 transition tooltip" title="Add person">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                        </button>
                        <button onclick="openRenameModal()" class="text-gray-500 hover:text-blue-500 transition tooltip ml-2" title="Rename chat">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                    </div>
                </div>

                <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-2 custom-scroll bg-gray-50 dark:bg-gray-900">
                    </div>

                <div class="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
                    <!-- Preview Panel (Staging) -->
                    <div id="preview-panel" class="hidden mb-2 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg flex justify-between items-center">
                        <div id="preview-content" class="flex gap-2 items-center"></div>
                        <button onclick="cancelAttachment()" class="text-gray-400 hover:text-red-500 ml-2 bg-white dark:bg-gray-800 rounded-full p-1 shadow-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <!-- Reply Panel -->
                    <div id="reply-panel" class="hidden mb-2 p-2 border-l-4 border-blue-500 bg-gray-50 dark:bg-gray-700/50 rounded-r flex justify-between items-center text-sm">
                        <span id="reply-content" class="text-gray-600 dark:text-gray-300 font-medium truncate"></span>
                        <button onclick="cancelReply()" class="text-gray-400 hover:text-red-500 ml-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <div class="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 px-4 py-2 rounded-xl">
                        <label class="cursor-pointer text-gray-400 hover:text-blue-500" title="Attach image or file">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                            <input type="file" class="hidden" onchange="handleFileUpload(event)">
                        </label>
                        <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 bg-transparent border-none focus:ring-0 text-gray-800 dark:text-white placeholder-gray-500">
                        
                        <button id="cancel-edit-button" onclick="cancelEdit()" class="text-gray-400 hover:text-red-500" style="display: none;">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        
                        <button onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg p-2 transition shadow-md">
                            <svg id="send-button-icon" class="w-5 h-5 transform rotate-90" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
                            <svg id="edit-button-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (New Chat, Add User, Rename, Settings) -->
    <div id="new-chat-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6">
            <h3 class="text-lg font-bold mb-4">Start New Chat</h3>
            <p class="text-sm text-gray-500 mb-4">Enter the email address of the user you want to chat with.</p>
            <input type="email" id="new-chat-email" placeholder="user@example.com" class="w-full mb-4 p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('new-chat-modal')" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                <button onclick="createNewChat()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Start Chat</button>
            </div>
        </div>
    </div>

    <div id="add-user-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6">
            <h3 class="text-lg font-bold mb-4">Add Person to Chat</h3>
            <input type="email" id="add-user-email" placeholder="user@example.com" class="w-full mb-4 p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('add-user-modal')" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                <button onclick="addUserToChat()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add</button>
            </div>
        </div>
    </div>
    
    <div id="rename-chat-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6">
            <h3 class="text-lg font-bold mb-4">Rename Chat</h3>
            <input type="text" id="rename-chat-input" placeholder="New chat name" class="w-full mb-4 p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('rename-chat-modal')" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                <button onclick="renameChat()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Rename</button>
            </div>
        </div>
    </div>
    
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold">Settings</h3>
                <button onclick="closeModal('settings-modal')" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Display Name</label>
                    <input type="text" id="settings-username" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div class="flex items-center justify-between py-2 border-t border-gray-100 dark:border-gray-700">
                    <span class="text-sm font-medium">Dark Mode</span>
                    <button onclick="toggleTheme()" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-blue-600 transition-colors">
                        <span class="translate-x-1 dark:translate-x-6 inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                    </button>
                </div>
            </div>

            <div class="mt-6 flex flex-col gap-3">
                <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Save Changes</button>
                
                <button onclick="resetPassword()" class="w-full border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    Reset Password
                </button>

                <button onclick="handleLogout(); closeModal('settings-modal')" class="w-full border border-red-200 text-red-500 py-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">Sign Out</button>
            </div>
        </div>
    </div>

</body>
</html>
